name: Build and Release Electron App

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: üß∞ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: üíæ Node modules cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Configure CI environment
        run: |
          set -e
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
        shell: bash

      - name: üì¶ Install dependencies (strict)
        run: npm ci
        shell: bash

      - name: ‚úèÔ∏è Check code style and lint
        run: |
          if [ -f "./node_modules/.bin/eslint" ]; then
            npm run lint || echo "::warning file=,title=Lint warnings::Linting failed but build will continue"
          else
            echo "No linter configured."
          fi
        shell: bash

      - name: üß™ Run tests
        run: |
          if [ -f "./node_modules/.bin/jest" ]; then
            npm test -- --ci --coverage || (echo "::error ::Tests failed" && exit 1)
          else
            echo "No tests to run"
          fi
        shell: bash

      # Signing steps for Windows/macOS would go here if configured

      - name: üèó Build Electron App for platform
        run: |
          set -e
          echo "Building for $RUNNER_OS..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            npm run build:win
          elif [ "$RUNNER_OS" = "macOS" ]; then
            npm run build:mac
          fi
        shell: bash

      # Separate upload for Windows .exe installer
      - name: üì§ Upload Windows installer
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: Windows-installer
          path: dist/*.exe
          if-no-files-found: error

      # Build artifact upload for macOS
      - name: üì§ Upload build artifacts (mac)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macOS-dist
          path: dist/
          if-no-files-found: error

  changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog with github-changelog-generator
        uses: heinrichreimer/github-changelog-generator-action@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output: CHANGELOG.md

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git diff-index --quiet HEAD || git commit -m "chore: update CHANGELOG.md for ${{ github.ref }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, changelog]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: üì• Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: üßæ Create GitHub Release with auto-notes
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
